name: Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Enable required services (idempotent)
        continue-on-error: true
        run: |
          gcloud services enable run.googleapis.com cloudbuild.googleapis.com artifactregistry.googleapis.com || true

      - name: Build backend image (Cloud Build)
        working-directory: backend
        run: |
          BUILD_ID=$(gcloud builds submit --tag gcr.io/${GCP_PROJECT_ID}/pristilbud-backend --async --format='value(id)')
          echo "Backend build ID: $BUILD_ID"
          echo "Waiting for backend build to complete..."
          gcloud builds log --stream $BUILD_ID || echo "Log streaming failed, checking build status..."
          gcloud builds describe $BUILD_ID --format='value(status)' | grep -q "SUCCESS" || (echo "Backend build failed" && exit 1)

      - name: Create backend env file for Cloud Run
        working-directory: backend
        run: |
          echo "GOOGLE_CREDENTIALS_JSON: '${{ secrets.SHEETS_CREDENTIALS_JSON }}'" > .cloudrun.env.yaml

      - name: Deploy backend to Cloud Run
        working-directory: backend
        run: |
          gcloud run deploy pristilbud-backend \
            --image gcr.io/${GCP_PROJECT_ID}/pristilbud-backend \
            --platform managed \
            --region ${GCP_REGION} \
            --allow-unauthenticated \
            --env-vars-file .cloudrun.env.yaml

      - name: Resolve backend URL
        id: backend
        run: |
          URL=$(gcloud run services describe pristilbud-backend --region ${GCP_REGION} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Build frontend image (Cloud Build) with backend URL
        working-directory: frontend
        run: |
          BUILD_ID=$(gcloud builds submit \
            --config cloudbuild.yaml \
            --substitutions _VITE_BACKEND_URL=${{ steps.backend.outputs.url }} \
            --async --format='value(id)')
          echo "Frontend build ID: $BUILD_ID"
          echo "Waiting for frontend build to complete..."
          gcloud builds log --stream $BUILD_ID || echo "Log streaming failed, checking build status..."
          gcloud builds describe $BUILD_ID --format='value(status)' | grep -q "SUCCESS" || (echo "Frontend build failed" && exit 1)

      - name: Deploy frontend to Cloud Run
        working-directory: frontend
        run: |
          gcloud run deploy pristilbud-frontend \
            --image gcr.io/${GCP_PROJECT_ID}/pristilbud-frontend \
            --platform managed \
            --region ${GCP_REGION} \
            --allow-unauthenticated


